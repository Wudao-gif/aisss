# 🧪 PDF 渐进式加载测试说明

## 🎯 测试目标
验证 PDF 渐进式加载功能是否正常工作，包括：
- ✅ 首次只加载前 10 页
- ✅ 翻页时自动预加载附近页面
- ✅ 已加载页面从缓存渲染
- ✅ 加载进度实时显示

---

## 📋 测试步骤

### 1️⃣ 准备测试文件
- 上传一个 **100 页以上的 PDF 文件**
- 确保文件 `allowReading = true`（支持预览）

### 2️⃣ 打开 PDF 文件
1. 在浏览器中打开 `book-chat?bookId=xxx` 页面
2. 点击左侧书籍封面或资源列表中的 PDF 文件
3. **打开浏览器控制台**（F12）

### 3️⃣ 观察初始加载
**预期日志**：
```
📄 [PDF] 开始加载文档: book-files/xxx.pdf
📄 [PDF] 文档加载成功，共 100 页
📄 [PDF] 🚀 开始渐进式加载，首次加载前 10 页
📄 [PDF] 🔄 实时渲染第 1 页
📄 [PDF] 🎨 开始渲染第 1 页到缓存
📄 [PDF] ✅ 第 1 页渲染完成
📄 [PDF] 📦 预加载第 1-6 页
📄 [PDF] 🎨 开始渲染第 2 页到缓存
📄 [PDF] ✅ 第 2 页渲染完成
...
```

**预期 UI**：
- 顶部工具栏显示：`已加载: 1 / 100 页`
- 正在加载时显示：`(正在加载第 X 页...)`
- 底部提示：`🚀 渐进式加载：翻页时自动加载附近内容`

### 4️⃣ 测试翻页（已缓存页面）
1. 点击"下一页"按钮，翻到第 2 页
2. 观察控制台日志

**预期日志**：
```
📄 [PDF] 💨 从缓存渲染第 2 页
```

**预期效果**：
- ✅ 页面**瞬间显示**（<10ms）
- ✅ 无需等待加载

### 5️⃣ 测试翻页（未缓存页面）
1. 点击"下一页"按钮多次，翻到第 20 页
2. 观察控制台日志

**预期日志**：
```
📄 [PDF] 🔄 实时渲染第 20 页
📄 [PDF] 📦 预加载第 15-25 页
📄 [PDF] 🎨 开始渲染第 15 页到缓存
📄 [PDF] ✅ 第 15 页渲染完成
📄 [PDF] 🎨 开始渲染第 16 页到缓存
...
```

**预期效果**：
- ✅ 第 20 页实时渲染（200-500ms）
- ✅ 自动预加载第 15-25 页
- ✅ 顶部显示加载进度变化

### 6️⃣ 测试返回已加载页面
1. 点击"上一页"按钮，返回第 19 页
2. 观察控制台日志

**预期日志**：
```
📄 [PDF] 💨 从缓存渲染第 19 页
```

**预期效果**：
- ✅ 页面**瞬间显示**（<10ms）

---

## 📊 性能对比

| 场景 | 传统加载 | 渐进式加载 | 提升 |
|------|---------|-----------|------|
| 打开 100 页 PDF | 10-30 秒 | 1-3 秒 | **80%+** |
| 首次翻页 | 200-500ms | 200-500ms | 相同 |
| 再次翻页（已缓存） | 200-500ms | <10ms | **95%+** |
| 内存占用 | 全部页面 | 已加载页面 | 节省 80%+ |

---

## ✅ 验收标准

### 必须满足：
- ✅ 打开 PDF 时，只加载前 10 页
- ✅ 翻页时，自动预加载当前页 ±5 页
- ✅ 已加载页面从缓存渲染（<10ms）
- ✅ 顶部显示加载进度：`已加载: X / Y 页`
- ✅ 控制台日志清晰显示加载过程

### 不应该出现：
- ❌ 打开时加载全部页面
- ❌ 翻页时重复加载已加载页面
- ❌ 缓存签名 URL（安全风险）
- ❌ 内存泄漏（关闭预览后缓存未清理）

---

## 🐛 常见问题

### 问题 1：打开时加载了全部页面
**原因**：`INITIAL_LOAD_PAGES` 设置错误  
**解决**：检查 `PDFViewer.tsx` 中的 `INITIAL_LOAD_PAGES` 是否为 10

### 问题 2：翻页时没有预加载
**原因**：`preloadNearbyPages` 函数未执行  
**解决**：检查 `useEffect` 依赖项是否正确

### 问题 3：已加载页面重复渲染
**原因**：缓存检查逻辑错误  
**解决**：检查 `pageCache.current.get(pageNumber)` 是否正确

### 问题 4：内存占用过高
**原因**：缓存未清理  
**解决**：检查 `useEffect` 的 cleanup 函数是否执行

---

## 🎉 测试完成！

如果所有测试通过，说明 PDF 渐进式加载功能正常工作！

