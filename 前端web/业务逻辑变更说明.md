# 业务逻辑变更说明

## 📋 变更概述

根据新的业务需求，图书管理系统的逻辑已更新：

### ✅ 新逻辑
1. **图书（教材）** - 全局共享，不绑定大学
2. **图书资源（资料列表）** - 按大学区分，同一本图书在不同大学有不同的资源

### ❌ 旧逻辑
1. ~~图书绑定大学~~
2. ~~每个大学有自己的图书列表~~

---

## 🔄 数据库变更

### Book 表
**移除字段**：
- ❌ `universityId` - 图书不再绑定大学
- ❌ `university` 关系

**保留字段**：
- ✅ `id`, `name`, `author`, `isbn`, `publisher`
- ✅ `coverUrl`, `fileUrl`, `fileSize`
- ✅ `createdAt`, `updatedAt`

**新增关系**：
- ✅ `resources` - 图书资源列表（按大学区分）

### BookResource 表（新增）
**字段**：
- ✅ `id` - 资源ID
- ✅ `bookId` - 图书ID
- ✅ `universityId` - **大学ID（重要）**
- ✅ `name` - 资源名称
- ✅ `description` - 资源描述
- ✅ `fileUrl` - 文件URL
- ✅ `fileType` - 文件类型
- ✅ `fileSize` - 文件大小
- ✅ `createdAt` - 创建时间

**关系**：
- ✅ `book` - 所属图书
- ✅ `university` - 所属大学

### University 表
**移除关系**：
- ❌ `books` - 不再有图书关系

**新增关系**：
- ✅ `bookResources` - 大学的图书资源

---

## 📝 API 变更

### 管理员 API

#### 1. 创建图书
**变更**：移除 `universityId` 参数

```diff
POST /api/admin/books
{
  "name": "图书名称",
  "author": "作者",
  "isbn": "ISBN",
  "publisher": "出版社",
- "universityId": "大学ID",
  "coverUrl": "封面URL（可选）",
  "fileUrl": "文件URL（可选）",
  "fileSize": 123456（可选）
}
```

#### 2. 获取图书列表
**变更**：移除 `universityId` 筛选参数

```diff
- GET /api/admin/books?universityId={universityId}&search={search}
+ GET /api/admin/books?search={search}
```

**响应变更**：
```diff
{
  "success": true,
  "data": {
    "books": [
      {
        "id": "...",
        "name": "...",
-       "university": { "id": "...", "name": "..." },
        "_count": {
          "bookshelf": 10,
+         "resources": 5
        }
      }
    ]
  }
}
```

#### 3. 获取图书资源列表
**新增**：支持按大学筛选

```diff
- GET /api/admin/books/{bookId}/resources
+ GET /api/admin/books/{bookId}/resources?universityId={universityId}
```

**响应变更**：
```diff
{
  "success": true,
  "data": [
    {
      "id": "...",
+     "universityId": "...",
      "name": "资源名称",
+     "university": {
+       "id": "...",
+       "name": "四川大学"
+     }
    }
  ]
}
```

#### 4. 添加图书资源
**新增**：必须指定 `universityId`

```diff
POST /api/admin/books/{bookId}/resources
{
+ "universityId": "大学ID",
  "name": "资源名称",
  "description": "资源描述（可选）",
  "fileUrl": "文件URL",
  "fileType": "pdf",
  "fileSize": 123456
}
```

### 客户端 API

#### 1. 获取图书列表
**变更**：移除 `universityId` 筛选，返回所有图书

```diff
- GET /api/books?universityId={universityId}&search={search}
+ GET /api/books?search={search}
```

#### 2. 获取图书资源列表（新增）
**新增**：根据用户所在大学自动筛选资源

```
GET /api/books/{bookId}/resources
Authorization: Bearer {token}
```

**逻辑**：
1. 从 token 中获取用户信息
2. 根据用户的 `university` 字段查找大学
3. 返回该大学的图书资源列表

---

## 🎯 业务场景示例

### 场景 1：添加图书
**管理员操作**：
1. 添加图书《高等数学》
2. 不需要选择大学
3. 所有大学的学生都能看到这本书

### 场景 2：添加资源
**管理员操作**：
1. 为《高等数学》添加资源
2. 选择"四川大学"
3. 上传四川大学的课件
4. 再次添加资源
5. 选择"北京大学"
6. 上传北京大学的课件

### 场景 3：学生查看
**四川大学学生**：
1. 登录系统
2. 看到《高等数学》
3. 打开图书详情
4. 只看到四川大学的课件

**北京大学学生**：
1. 登录系统
2. 看到《高等数学》（同一本书）
3. 打开图书详情
4. 只看到北京大学的课件

---

## 🔧 前端变更

### 图书管理页面
**移除**：
- ❌ 大学筛选器
- ❌ 表单中的大学选择字段
- ❌ 表格中的大学列

**新增**：
- ✅ 表格中的资源数列

### 资源管理弹窗（待实现）
**新增**：
- ✅ 大学选择器（筛选资源）
- ✅ 添加资源时选择大学
- ✅ 显示资源所属大学

---

## ⚠️ 迁移步骤

### 1. 数据库迁移
```bash
npx prisma db push
npx prisma generate
```

### 2. 数据迁移（如果有现有数据）
如果数据库中已有图书数据：
1. 备份数据库
2. 移除 `universityId` 外键约束
3. 删除 `universityId` 列
4. 如果需要保留资源数据，需要手动迁移到 `BookResource` 表

### 3. 重启服务
```bash
npm run dev
```

---

## ✅ 测试清单

- [ ] 创建图书（不选择大学）
- [ ] 查看图书列表（显示所有图书）
- [ ] 为图书添加资源（选择大学A）
- [ ] 为同一图书添加资源（选择大学B）
- [ ] 用大学A的学生账号登录
- [ ] 查看图书资源（只看到大学A的资源）
- [ ] 用大学B的学生账号登录
- [ ] 查看图书资源（只看到大学B的资源）

---

## 📚 相关文档

- `图书管理功能说明.md` - 完整功能说明
- `阿里云OSS配置指南.md` - OSS 配置步骤
- `prisma/schema.prisma` - 数据库 Schema

---

## 🎉 优势

### 1. 简化管理
- ✅ 图书只需添加一次
- ✅ 避免重复录入
- ✅ 统一管理图书基本信息

### 2. 灵活性
- ✅ 每个大学可以自定义资源
- ✅ 资源可以不同
- ✅ 满足各大学的个性化需求

### 3. 可扩展性
- ✅ 新增大学时，自动看到所有图书
- ✅ 可以逐步为新大学添加资源
- ✅ 不影响其他大学

---

如有问题，请查看相关文档或联系开发团队。

