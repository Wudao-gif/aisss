# 图书管理功能说明

## 📚 功能概述

图书管理功能已完成升级，现在支持：

1. **图书封面上传** - 上传图书封面图片
2. **图书文件上传** - 上传图书PDF文件
3. **图书资源管理** - 为每本图书添加多个资料文件（按大学区分）
4. **阿里云 OSS 集成** - 所有文件存储在阿里云对象存储

## 🎯 核心业务逻辑

### 图书（教材）
- ✅ **全局共享** - 图书不绑定大学
- ✅ **所有用户可见** - 不管用户属于哪个大学，都能看到所有图书
- ✅ **基本信息** - 包含书名、作者、ISBN、出版社、封面、文件

### 图书资源（资料列表）
- ✅ **按大学区分** - 每个大学可以为同一本图书添加不同的资源
- ✅ **差异化内容** - 四川大学和北京大学打开同一本图书，看到的资源列表不同
- ✅ **资源类型** - 课件、习题、参考资料等各种文档

---

## 🗄️ 数据库变更

### Book 表变更

**移除字段**：
- ❌ `universityId` - 图书不再绑定大学

**新增字段**：
```prisma
model Book {
  id           String   @id @default(uuid())
  name         String
  author       String
  isbn         String   @unique
  publisher    String
  coverUrl     String?  @map("cover_url")
  fileUrl      String?  @map("file_url")      // 图书文件 URL（PDF等）
  fileSize     Int?     @map("file_size")     // 文件大小（字节）
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关系
  bookshelf    BookshelfItem[]
  resources    BookResource[]  // 图书资源（按大学区分）
}
```

### 新增 BookResource 表

**重要**：资源绑定大学，同一本图书在不同大学有不同的资源列表

```prisma
model BookResource {
  id           String   @id @default(uuid())
  bookId       String   @map("book_id")
  universityId String   @map("university_id")  // 绑定大学
  name         String   // 资源名称
  description  String?  // 资源描述
  fileUrl      String   @map("file_url")  // 文件 URL
  fileType     String   @map("file_type") // 文件类型（pdf, doc, ppt等）
  fileSize     Int      @map("file_size") // 文件大小（字节）
  createdAt    DateTime @default(now()) @map("created_at")

  // 关系
  book         Book       @relation(fields: [bookId], references: [id], onDelete: Cascade)
  university   University @relation(fields: [universityId], references: [id])
}
```

---

## 🚀 部署步骤

### 1. 安装依赖

```bash
npm install ali-oss
```

### 2. 配置环境变量

复制 `.env.example` 为 `.env.local`，并填入阿里云 OSS 配置：

```env
# 阿里云 OSS 配置
NEXT_PUBLIC_OSS_REGION="oss-cn-hangzhou"
NEXT_PUBLIC_OSS_BUCKET="your-bucket-name"
OSS_ACCESS_KEY_ID="your-access-key-id"
OSS_ACCESS_KEY_SECRET="your-access-key-secret"
```

详细配置步骤请参考：`阿里云OSS配置指南.md`

### 3. 更新数据库

运行 Prisma 迁移：

```bash
npx prisma migrate dev --name add_book_files_and_resources
```

或者直接推送 schema 变更：

```bash
npx prisma db push
```

### 4. 重新生成 Prisma Client

```bash
npx prisma generate
```

### 5. 启动开发服务器

```bash
npm run dev
```

---

## 📖 使用指南

### 添加图书

1. 登录管理员账号
2. 进入「图书管理」页面
3. 点击「+ 添加图书」
4. 填写图书信息：
   - 书名 *
   - 作者 *
   - ISBN *
   - 出版社 *
   - 封面图片（可选）
   - 图书文件（可选）
5. 点击「添加」

**注意**：图书是全局的，不需要选择大学

### 上传封面

- 支持格式：JPG, PNG, GIF, WebP
- 最大大小：100MB
- 上传后会显示预览

### 上传图书文件

- 支持格式：PDF, DOC, DOCX, PPT, PPTX, XLS, XLSX
- 最大大小：100MB
- 上传后可以下载查看

### 管理图书资源

1. 在图书列表中，点击「管理资源」按钮
2. 在资源管理弹窗中：
   - **选择大学** - 选择要为哪个大学添加资源
   - 查看该大学的资源列表
   - 点击「+ 添加资源」上传新资源
   - 填写资源名称和描述
   - 上传资源文件
   - 点击「添加」
3. 删除资源：点击资源旁的「删除」按钮

**重要**：
- 同一本图书可以为不同大学添加不同的资源
- 四川大学的学生只能看到四川大学的资源
- 北京大学的学生只能看到北京大学的资源

---

## 🔧 API 接口

### 文件上传

```
POST /api/upload
Authorization: Bearer {token}
Content-Type: multipart/form-data

Body:
- file: File
- folder: string (可选，默认 "uploads")

Response:
{
  "success": true,
  "data": {
    "url": "https://...",
    "size": 123456,
    "type": "pdf",
    "name": "example.pdf"
  }
}
```

### 创建图书（全局）

```
POST /api/admin/books
Authorization: Bearer {token}
Content-Type: application/json

Body:
{
  "name": "图书名称",
  "author": "作者",
  "isbn": "ISBN",
  "publisher": "出版社",
  "coverUrl": "封面URL（可选）",
  "fileUrl": "文件URL（可选）",
  "fileSize": 123456（可选）
}
```

**注意**：不需要 `universityId`，图书是全局的

### 获取图书资源列表（可按大学筛选）

```
GET /api/admin/books/{bookId}/resources?universityId={universityId}
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": [
    {
      "id": "...",
      "bookId": "...",
      "universityId": "...",
      "name": "资源名称",
      "description": "资源描述",
      "fileUrl": "...",
      "fileType": "pdf",
      "fileSize": 123456,
      "createdAt": "...",
      "university": {
        "id": "...",
        "name": "四川大学"
      }
    }
  ]
}
```

**参数**：
- `universityId`（可选）- 筛选特定大学的资源
- 不传则返回所有大学的资源

### 添加图书资源（需指定大学）

```
POST /api/admin/books/{bookId}/resources
Authorization: Bearer {token}
Content-Type: application/json

Body:
{
  "universityId": "大学ID",
  "name": "资源名称",
  "description": "资源描述（可选）",
  "fileUrl": "文件URL",
  "fileType": "pdf",
  "fileSize": 123456
}
```

**重要**：必须指定 `universityId`，资源属于特定大学

### 删除图书资源

```
DELETE /api/admin/books/{bookId}/resources/{resourceId}
Authorization: Bearer {token}

Response:
{
  "success": true,
  "message": "资源删除成功"
}
```

---

## 📁 文件结构

### 新增文件

```
Desktop/前端web/
├── lib/
│   └── oss.ts                          # OSS 工具函数
├── app/
│   └── api/
│       ├── upload/
│       │   └── route.ts                # 文件上传 API
│       └── admin/
│           └── books/
│               └── [id]/
│                   └── resources/
│                       ├── route.ts    # 资源列表 API
│                       └── [resourceId]/
│                           └── route.ts # 单个资源 API
├── components/
│   └── admin/
│       └── FileUpload.tsx              # 文件上传组件
├── prisma/
│   └── schema.prisma                   # 更新的数据库 Schema
├── 阿里云OSS配置指南.md                 # OSS 配置指南
└── 图书管理功能说明.md                  # 本文档
```

### 修改的文件

```
Desktop/前端web/
├── app/
│   └── api/
│       └── admin/
│           └── books/
│               ├── route.ts            # 支持文件字段
│               └── [id]/
│                   └── route.ts        # 支持文件字段
└── prisma/
    └── schema.prisma                   # 添加文件字段和资源表
```

---

## ⚠️ 注意事项

### 1. 环境变量安全

- ❌ 不要将 `.env.local` 提交到 Git
- ✅ 确保 `.env.local` 在 `.gitignore` 中
- ✅ 使用 RAM 子账号，不要使用主账号 AccessKey

### 2. 文件大小限制

- 当前限制：100MB
- 可在 `/api/upload/route.ts` 中修改 `maxSize` 变量

### 3. 文件类型限制

- 当前支持：图片、PDF、Office 文档
- 可在 `/api/upload/route.ts` 中修改 `allowedTypes` 数组

### 4. OSS 费用

- 按存储空间和流量计费
- 建议开启费用预警
- 定期清理不需要的文件

### 5. 删除文件

- 删除图书资源时会同时删除 OSS 文件
- 删除图书时不会自动删除封面和文件（需要手动实现）

---

## 🐛 故障排查

### 上传失败

1. 检查环境变量是否正确配置
2. 检查 OSS AccessKey 权限
3. 检查文件大小和类型是否符合要求
4. 查看浏览器控制台和服务器日志

### 文件无法访问

1. 检查 Bucket 权限设置（公共读 vs 私有）
2. 如果是私有 Bucket，需要使用签名 URL
3. 检查 CORS 配置

### 数据库错误

1. 确保已运行 Prisma 迁移
2. 检查数据库连接
3. 查看 Prisma 日志

---

## 🎯 后续优化建议

### 1. 客户端直传

- 使用 STS 临时凭证
- 客户端直接上传到 OSS
- 减轻服务器压力

### 2. 图片处理

- 使用 OSS 图片处理功能
- 自动生成缩略图
- 压缩图片大小

### 3. CDN 加速

- 配置阿里云 CDN
- 加速文件下载
- 降低流量费用

### 4. 文件预览

- 集成 PDF.js 预览 PDF
- Office 文档在线预览
- 图片灯箱效果

### 5. 批量操作

- 批量上传文件
- 批量删除资源
- 导入导出功能

---

## ✅ 测试清单

- [ ] 安装 ali-oss 依赖
- [ ] 配置阿里云 OSS
- [ ] 配置环境变量
- [ ] 运行数据库迁移
- [ ] 启动开发服务器
- [ ] 测试上传图书封面
- [ ] 测试上传图书文件
- [ ] 测试添加图书资源
- [ ] 测试删除图书资源
- [ ] 测试文件访问

---

如有问题，请查看：
- `阿里云OSS配置指南.md` - OSS 配置详细步骤
- 控制台日志 - 查看错误信息
- Prisma 文档 - 数据库相关问题

