# ğŸ—„ï¸ æ•°æ®åº“è®¾ç½®æŒ‡å—

**åˆ›å»ºæ—¶é—´**: 2025-11-07

---

## âœ… å·²å®Œæˆçš„å‡†å¤‡å·¥ä½œ

1. âœ… PostgreSQL å®¹å™¨å·²è¿è¡Œï¼ˆ`my-auth-postgres`ï¼‰
2. âœ… æ•°æ®åº“å·²åˆ›å»ºï¼ˆ`user_auth_db`ï¼‰
3. âœ… Prisma Schema å·²åˆ›å»ºï¼ˆ`prisma/schema.prisma`ï¼‰
4. âœ… ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆ`.env`ï¼‰

---

## ğŸ“‹ æ•°æ®åº“è¿æ¥ä¿¡æ¯

```
å®¹å™¨åç§°: my-auth-postgres
æ•°æ®åº“ä¸»æœº: localhost
ç«¯å£: 5432
æ•°æ®åº“å: user_auth_db
ç”¨æˆ·å: postgres
å¯†ç : mysecretpassword
```

**è¿æ¥å­—ç¬¦ä¸²**:
```
postgresql://postgres:mysecretpassword@localhost:5432/user_auth_db?schema=public
```

---

## ğŸš€ æ¥ä¸‹æ¥çš„æ­¥éª¤

### æ­¥éª¤ 1: å®‰è£… Prisma

åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œï¼š

```bash
cd C:\Users\daowu\Desktop\å‰ç«¯web
npm install prisma @prisma/client --legacy-peer-deps
```

**è¯´æ˜**: ä½¿ç”¨ `--legacy-peer-deps` æ˜¯å› ä¸ºé¡¹ç›®ä½¿ç”¨ React 19ï¼Œè€Œ Next.js 14 éœ€è¦ React 18ã€‚

---

### æ­¥éª¤ 2: ç”Ÿæˆ Prisma Client

```bash
npx prisma generate
```

è¿™ä¼šæ ¹æ® `schema.prisma` ç”Ÿæˆ TypeScript ç±»å‹å’Œæ•°æ®åº“å®¢æˆ·ç«¯ã€‚

---

### æ­¥éª¤ 3: åˆ›å»ºæ•°æ®åº“è¡¨

```bash
npx prisma db push
```

è¿™ä¼šåœ¨ PostgreSQL æ•°æ®åº“ä¸­åˆ›å»ºæ‰€æœ‰è¡¨ã€‚

---

### æ­¥éª¤ 4: æŸ¥çœ‹æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

ä½¿ç”¨ Prisma Studio å¯è§†åŒ–æŸ¥çœ‹æ•°æ®åº“ï¼š

```bash
npx prisma studio
```

è¿™ä¼šåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `http://localhost:5555`ï¼Œå¯ä»¥æŸ¥çœ‹å’Œç¼–è¾‘æ•°æ®ã€‚

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### 1. usersï¼ˆç”¨æˆ·è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| email | String | é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰ |
| password | String | å¯†ç ï¼ˆåŠ å¯†ï¼‰ |
| real_name | String | çœŸå®å§“å |
| university | String | æ‰€åœ¨å¤§å­¦ |
| wechat_open_id | String? | å¾®ä¿¡ OpenIDï¼ˆå¯é€‰ï¼Œå”¯ä¸€ï¼‰ |
| is_banned | Boolean | æ˜¯å¦å°ç¦ |
| created_at | DateTime | åˆ›å»ºæ—¶é—´ |
| updated_at | DateTime | æ›´æ–°æ—¶é—´ |

---

### 2. universitiesï¼ˆå¤§å­¦è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| name | String | å¤§å­¦åç§°ï¼ˆå”¯ä¸€ï¼‰ |
| logo_url | String? | LOGO å›¾ç‰‡ URL |
| created_at | DateTime | åˆ›å»ºæ—¶é—´ |

---

### 3. booksï¼ˆå›¾ä¹¦è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| name | String | å›¾ä¹¦åç§° |
| author | String | ä½œè€… |
| isbn | String | ISBNï¼ˆå”¯ä¸€ï¼‰ |
| publisher | String | å‡ºç‰ˆç¤¾ |
| university_id | UUID | æ‰€å±å¤§å­¦ ID |
| cover_url | String? | å°é¢å›¾ç‰‡ URL |
| created_at | DateTime | åˆ›å»ºæ—¶é—´ |

---

### 4. bookshelfï¼ˆä¹¦æ¶è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| user_id | UUID | ç”¨æˆ· ID |
| book_id | UUID | å›¾ä¹¦ ID |
| added_at | DateTime | æ·»åŠ æ—¶é—´ |

**å”¯ä¸€çº¦æŸ**: (user_id, book_id) - åŒä¸€ç”¨æˆ·ä¸èƒ½é‡å¤æ·»åŠ åŒä¸€æœ¬ä¹¦

---

### 5. conversationsï¼ˆå¯¹è¯è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| user_id | UUID | ç”¨æˆ· ID |
| title | String | å¯¹è¯æ ‡é¢˜ |
| created_at | DateTime | åˆ›å»ºæ—¶é—´ |
| updated_at | DateTime | æ›´æ–°æ—¶é—´ |

---

### 6. messagesï¼ˆæ¶ˆæ¯è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| conversation_id | UUID | å¯¹è¯ ID |
| role | String | è§’è‰²ï¼ˆ'user' æˆ– 'assistant'ï¼‰ |
| content | Text | æ¶ˆæ¯å†…å®¹ |
| created_at | DateTime | åˆ›å»ºæ—¶é—´ |

---

## ğŸ”— è¡¨å…³ç³»

```
User (ç”¨æˆ·)
â”œâ”€â”€ BookshelfItem[] (ä¹¦æ¶)
â””â”€â”€ Conversation[] (å¯¹è¯)
    â””â”€â”€ Message[] (æ¶ˆæ¯)

University (å¤§å­¦)
â””â”€â”€ Book[] (å›¾ä¹¦)
    â””â”€â”€ BookshelfItem[] (ä¹¦æ¶)
```

---

## ğŸ“ ä¸‹ä¸€æ­¥ï¼šåˆ›å»º API Routes

å®‰è£…å®Œ Prisma å¹¶ç”Ÿæˆæ•°æ®åº“è¡¨åï¼Œæˆ‘ä¼šå¸®ä½ åˆ›å»ºï¼š

1. **Prisma Client å®ä¾‹** (`lib/prisma.ts`)
2. **API Routes**:
   - `/api/auth/register` - ç”¨æˆ·æ³¨å†Œ
   - `/api/auth/login` - ç”¨æˆ·ç™»å½•
   - `/api/auth/logout` - ç”¨æˆ·ç™»å‡º
   - `/api/universities` - è·å–å¤§å­¦åˆ—è¡¨
   - `/api/books` - è·å–å›¾ä¹¦åˆ—è¡¨
   - `/api/bookshelf` - ä¹¦æ¶ç®¡ç†
   - `/api/conversations` - å¯¹è¯ç®¡ç†

3. **æ›´æ–°å‰ç«¯ä»£ç **:
   - ä¿®æ”¹ `lib/api/auth.ts` è°ƒç”¨çœŸå® API
   - ä¿®æ”¹ `lib/api/books.ts` è°ƒç”¨çœŸå® API
   - ç§»é™¤ localStorage æ¨¡æ‹Ÿæ•°æ®

---

## ğŸ§ª æµ‹è¯•æ•°æ®åº“è¿æ¥

å®‰è£…å®Œ Prisma åï¼Œå¯ä»¥è¿è¡Œè¿™ä¸ªå‘½ä»¤æµ‹è¯•è¿æ¥ï¼š

```bash
npx prisma db pull
```

å¦‚æœè¿æ¥æˆåŠŸï¼Œä¼šæ˜¾ç¤ºæ•°æ®åº“ä¿¡æ¯ã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¯†ç åŠ å¯†

ç”¨æˆ·å¯†ç éœ€è¦åŠ å¯†å­˜å‚¨ï¼Œæˆ‘ä¼šä½¿ç”¨ `bcrypt` åº“ï¼š

```bash
npm install bcrypt
npm install --save-dev @types/bcrypt
```

### 2. JWT Token

ç”¨æˆ·ç™»å½•åéœ€è¦ç”Ÿæˆ JWT Tokenï¼Œæˆ‘ä¼šä½¿ç”¨ `jsonwebtoken` åº“ï¼š

```bash
npm install jsonwebtoken
npm install --save-dev @types/jsonwebtoken
```

### 3. ç¯å¢ƒå˜é‡

éœ€è¦æ·»åŠ  JWT å¯†é’¥åˆ° `.env`ï¼š

```
JWT_SECRET="your-secret-key-here"
```

---

## ğŸ¯ å®Œæ•´å®‰è£…å‘½ä»¤

ä½ å¯ä»¥ä¸€æ¬¡æ€§è¿è¡Œæ‰€æœ‰å®‰è£…å‘½ä»¤ï¼š

```bash
cd C:\Users\daowu\Desktop\å‰ç«¯web

# å®‰è£… Prisma
npm install prisma @prisma/client --legacy-peer-deps

# å®‰è£…å¯†ç åŠ å¯†åº“
npm install bcrypt --legacy-peer-deps
npm install --save-dev @types/bcrypt --legacy-peer-deps

# å®‰è£… JWT åº“
npm install jsonwebtoken --legacy-peer-deps
npm install --save-dev @types/jsonwebtoken --legacy-peer-deps

# ç”Ÿæˆ Prisma Client
npx prisma generate

# åˆ›å»ºæ•°æ®åº“è¡¨
npx prisma db push

# æŸ¥çœ‹æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
npx prisma studio
```

---

## ğŸ“ é‡åˆ°é—®é¢˜ï¼Ÿ

### é—®é¢˜ 1: æ— æ³•è¿æ¥æ•°æ®åº“

**æ£€æŸ¥**:
1. PostgreSQL å®¹å™¨æ˜¯å¦è¿è¡Œï¼š`docker ps`
2. ç«¯å£æ˜¯å¦æ­£ç¡®ï¼š`5432`
3. å¯†ç æ˜¯å¦æ­£ç¡®ï¼š`mysecretpassword`

**è§£å†³**:
```bash
# é‡å¯å®¹å™¨
docker restart my-auth-postgres

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs my-auth-postgres
```

---

### é—®é¢˜ 2: Prisma å®‰è£…å¤±è´¥

**è§£å†³**:
```bash
# æ¸…é™¤ npm ç¼“å­˜
npm cache clean --force

# åˆ é™¤ node_modules
rm -rf node_modules
rm package-lock.json

# é‡æ–°å®‰è£…
npm install
npm install prisma @prisma/client --legacy-peer-deps
```

---

### é—®é¢˜ 3: æ•°æ®åº“è¡¨åˆ›å»ºå¤±è´¥

**è§£å†³**:
```bash
# æŸ¥çœ‹ Prisma æ—¥å¿—
npx prisma db push --preview-feature

# æˆ–è€…ä½¿ç”¨ migrate
npx prisma migrate dev --name init
```

---

## âœ… å®Œæˆåå‘Šè¯‰æˆ‘

å®‰è£…å®Œæˆåï¼Œå‘Šè¯‰æˆ‘ç»“æœï¼Œæˆ‘ä¼šç»§ç»­å¸®ä½ ï¼š

1. åˆ›å»º Prisma Client å®ä¾‹
2. åˆ›å»º API Routes
3. æ›´æ–°å‰ç«¯ä»£ç 
4. è¿ç§»ç°æœ‰æ•°æ®
5. æµ‹è¯•å®Œæ•´æµç¨‹

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿå¼€å§‹å®‰è£…å§ï¼** ğŸš€

