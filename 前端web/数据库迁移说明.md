# æ•°æ®åº“è¿ç§»è¯´æ˜

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

### 1. èµ„æºç®¡ç†ä¼˜åŒ–
- èµ„æºå¯ä»¥ç»‘å®šå¤šä¸ªæ•™æï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
- ç”¨æˆ·åŠ å…¥ä¹¦æ¶æ—¶åˆ›å»ºèµ„æºå¿«ç…§ï¼ˆä¸éšåå°æ›´æ–°ï¼‰
- ç”¨æˆ·å¯ä»¥ä¸Šä¼ ç§æœ‰èµ„æº

### 2. æ•°æ®æ¨¡å‹å˜æ›´

#### æ–°å¢è¡¨ï¼š`book_resource_relations`ï¼ˆå›¾ä¹¦-èµ„æºå…³è”è¡¨ï¼‰
```sql
CREATE TABLE book_resource_relations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  book_id UUID NOT NULL REFERENCES books(id) ON DELETE CASCADE,
  resource_id UUID NOT NULL REFERENCES book_resources(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(book_id, resource_id)
);
```

#### æ–°å¢è¡¨ï¼š`bookshelf_resources`ï¼ˆä¹¦æ¶èµ„æºå¿«ç…§è¡¨ï¼‰
```sql
CREATE TABLE bookshelf_resources (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  bookshelf_item_id UUID NOT NULL REFERENCES bookshelf(id) ON DELETE CASCADE,
  resource_id UUID REFERENCES book_resources(id) ON DELETE SET NULL,
  user_id UUID NOT NULL,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  file_url VARCHAR(500) NOT NULL,
  file_type VARCHAR(50) NOT NULL,
  file_size INTEGER NOT NULL,
  allow_reading BOOLEAN DEFAULT TRUE,
  is_user_uploaded BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### ä¿®æ”¹è¡¨ï¼š`book_resources`
- ç§»é™¤ `book_id` å­—æ®µï¼ˆæ”¹ä¸ºå¤šå¯¹å¤šå…³ç³»ï¼‰
- ä¿ç•™å…¶ä»–å­—æ®µä¸å˜

## ğŸ”„ è¿ç§»æ­¥éª¤

### æ­¥éª¤ 1ï¼šå¤‡ä»½ç°æœ‰æ•°æ®
```bash
# å¯¼å‡ºç°æœ‰çš„ book_resources æ•°æ®
pg_dump -U your_user -d your_db -t book_resources > book_resources_backup.sql
```

### æ­¥éª¤ 2ï¼šåˆ›å»ºæ–°è¡¨
```bash
# è¿è¡Œ Prisma è¿ç§»
npx prisma migrate dev --name add_resource_snapshot_and_multi_book_binding
```

### æ­¥éª¤ 3ï¼šæ•°æ®è¿ç§»è„šæœ¬
```sql
-- 1. å°†ç°æœ‰çš„ book_resources æ•°æ®è¿ç§»åˆ° book_resource_relations
INSERT INTO book_resource_relations (book_id, resource_id, created_at)
SELECT book_id, id, created_at
FROM book_resources
WHERE book_id IS NOT NULL;

-- 2. ä¸ºç°æœ‰ä¹¦æ¶é¡¹åˆ›å»ºèµ„æºå¿«ç…§
INSERT INTO bookshelf_resources (
  bookshelf_item_id,
  resource_id,
  user_id,
  name,
  description,
  file_url,
  file_type,
  file_size,
  allow_reading,
  is_user_uploaded,
  created_at
)
SELECT 
  bs.id as bookshelf_item_id,
  br.id as resource_id,
  bs.user_id,
  br.name,
  br.description,
  br.file_url,
  br.file_type,
  br.file_size,
  br.allow_reading,
  FALSE as is_user_uploaded,
  bs.added_at as created_at
FROM bookshelf bs
JOIN book_resource_relations brr ON brr.book_id = bs.book_id
JOIN book_resources br ON br.id = brr.resource_id;

-- 3. åˆ é™¤ book_resources è¡¨çš„ book_id åˆ—
ALTER TABLE book_resources DROP COLUMN book_id;
```

### æ­¥éª¤ 4ï¼šéªŒè¯æ•°æ®
```sql
-- æ£€æŸ¥å…³è”å…³ç³»
SELECT COUNT(*) FROM book_resource_relations;

-- æ£€æŸ¥ä¹¦æ¶èµ„æºå¿«ç…§
SELECT COUNT(*) FROM bookshelf_resources;

-- æ£€æŸ¥æ˜¯å¦æœ‰å­¤ç«‹çš„èµ„æº
SELECT * FROM book_resources br
WHERE NOT EXISTS (
  SELECT 1 FROM book_resource_relations brr WHERE brr.resource_id = br.id
);
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šè¿ç§»å‰ç¡®ä¿å¤‡ä»½æ•°æ®åº“
2. **å¤–é”®çº¦æŸ**ï¼šæ–°è¡¨ä½¿ç”¨ `ON DELETE CASCADE` ç¡®ä¿çº§è”åˆ é™¤
3. **èµ„æºå¿«ç…§**ï¼šç”¨æˆ·ä¹¦æ¶ä¸­çš„èµ„æºæ˜¯å¿«ç…§ï¼Œä¸ä¼šéšå®˜æ–¹èµ„æºæ›´æ–°è€Œå˜åŒ–
4. **ç”¨æˆ·ä¸Šä¼ **ï¼š`is_user_uploaded = true` çš„èµ„æºä»…ç”¨æˆ·è‡ªå·±å¯è§

## ğŸ“ å›æ»šæ–¹æ¡ˆ

å¦‚æœè¿ç§»å¤±è´¥ï¼Œå¯ä»¥ä½¿ç”¨å¤‡ä»½æ¢å¤ï¼š
```bash
psql -U your_user -d your_db < book_resources_backup.sql
```

