<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡ä»¶è®¿é—®æƒé™æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f8f9fa;
      font-weight: bold;
      color: #333;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .loading { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <h1>ğŸ“š æ–‡ä»¶è®¿é—®æƒé™æµ‹è¯•</h1>

  <div class="card">
    <h2>ğŸ“‹ è¯´æ˜</h2>
    <p>è¿™ä¸ªé¡µé¢æ˜¾ç¤ºæ‰€æœ‰å›¾ä¹¦å’Œèµ„æºçš„æ–‡ä»¶è®¿é—®æƒé™è®¾ç½®ã€‚</p>
    <ul>
      <li><strong>å›¾ä¹¦æ–‡ä»¶</strong>: å›¾ä¹¦æœ¬èº«çš„PDFæ–‡ä»¶ï¼Œç”± <code>allowReading</code> å­—æ®µæ§åˆ¶</li>
      <li><strong>èµ„æºæ–‡ä»¶</strong>: å›¾ä¹¦çš„é™„åŠ èµ„æºï¼ˆè¯¾ä»¶ã€ä¹ é¢˜ç­‰ï¼‰ï¼Œæ¯ä¸ªèµ„æºæœ‰ç‹¬ç«‹çš„ <code>allowReading</code> å­—æ®µ</li>
    </ul>
    <button onclick="loadData()">åˆ·æ–°æ•°æ®</button>
  </div>

  <div class="card">
    <h2>ğŸ“Š åŠ è½½çŠ¶æ€</h2>
    <div id="status"></div>
  </div>

  <div class="card">
    <h2>ğŸ“– å›¾ä¹¦æ–‡ä»¶è®¿é—®æƒé™</h2>
    <div id="books-container"></div>
  </div>

  <div class="card">
    <h2>ğŸ“ èµ„æºæ–‡ä»¶è®¿é—®æƒé™</h2>
    <div id="resources-container"></div>
  </div>

  <script>
    async function loadData() {
      const statusDiv = document.getElementById('status')
      const booksContainer = document.getElementById('books-container')
      const resourcesContainer = document.getElementById('resources-container')

      statusDiv.innerHTML = '<div class="status loading">â³ æ­£åœ¨åŠ è½½æ•°æ®...</div>'
      booksContainer.innerHTML = ''
      resourcesContainer.innerHTML = ''

      try {
        // åŠ è½½å›¾ä¹¦æ•°æ®
        const booksResponse = await fetch('/api/books')
        const booksData = await booksResponse.json()

        if (!booksData.success) {
          statusDiv.innerHTML = `<div class="status error">âŒ åŠ è½½å›¾ä¹¦å¤±è´¥: ${booksData.message}</div>`
          return
        }

        const books = booksData.data || []

        // æ˜¾ç¤ºå›¾ä¹¦è¡¨æ ¼
        let booksHTML = `
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>ä¹¦å</th>
                <th>ISBN</th>
                <th>æ–‡ä»¶URL</th>
                <th>å…è®¸é˜…è¯»</th>
                <th>çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody>
        `

        books.forEach((book, index) => {
          const hasFile = book.fileUrl && book.fileUrl.trim() !== ''
          const canRead = book.allowReading
          
          let statusBadge = ''
          if (!hasFile) {
            statusBadge = '<span class="badge badge-warning">æ— æ–‡ä»¶</span>'
          } else if (canRead) {
            statusBadge = '<span class="badge badge-success">å¯è®¿é—®</span>'
          } else {
            statusBadge = '<span class="badge badge-danger">ä¸å¯è®¿é—®</span>'
          }

          booksHTML += `
            <tr>
              <td>${index + 1}</td>
              <td><strong>${book.name}</strong></td>
              <td>${book.isbn}</td>
              <td>${hasFile ? `<code style="font-size: 11px;">${book.fileUrl.substring(0, 50)}...</code>` : 'æ— '}</td>
              <td>${canRead ? 'âœ… æ˜¯' : 'âŒ å¦'}</td>
              <td>${statusBadge}</td>
            </tr>
          `
        })

        booksHTML += `
            </tbody>
          </table>
        `

        booksContainer.innerHTML = booksHTML

        // ç»Ÿè®¡
        const withFile = books.filter(b => b.fileUrl && b.fileUrl.trim() !== '').length
        const canReadCount = books.filter(b => b.allowReading).length
        const accessibleCount = books.filter(b => b.fileUrl && b.fileUrl.trim() !== '' && b.allowReading).length

        statusDiv.innerHTML = `
          <div class="status success">
            âœ… æˆåŠŸåŠ è½½ ${books.length} æœ¬å›¾ä¹¦<br>
            ğŸ“Š ç»Ÿè®¡: ${withFile} æœ¬æœ‰æ–‡ä»¶ | ${canReadCount} æœ¬å…è®¸é˜…è¯» | ${accessibleCount} æœ¬å¯è®¿é—®
          </div>
        `

        // åŠ è½½èµ„æºæ•°æ®ï¼ˆéœ€è¦ç™»å½•ï¼‰
        const token = localStorage.getItem('authToken')
        if (!token) {
          resourcesContainer.innerHTML = '<p class="status error">âŒ è¯·å…ˆç™»å½•æŸ¥çœ‹èµ„æºæ•°æ®</p>'
          return
        }

        // è·å–æ‰€æœ‰å›¾ä¹¦çš„èµ„æº
        let allResources = []
        for (const book of books) {
          try {
            const resourcesResponse = await fetch(`/api/books/${book.id}/resources`, {
              headers: {
                'Authorization': `Bearer ${token}`,
              },
            })
            const resourcesData = await resourcesResponse.json()
            if (resourcesData.success && resourcesData.data) {
              allResources = allResources.concat(
                resourcesData.data.map(r => ({
                  ...r,
                  bookName: book.name,
                }))
              )
            }
          } catch (error) {
            console.error(`è·å–å›¾ä¹¦ ${book.name} çš„èµ„æºå¤±è´¥:`, error)
          }
        }

        if (allResources.length === 0) {
          resourcesContainer.innerHTML = '<p class="status error">âŒ æ²¡æœ‰æ‰¾åˆ°èµ„æºæ•°æ®</p>'
          return
        }

        // æ˜¾ç¤ºèµ„æºè¡¨æ ¼
        let resourcesHTML = `
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>èµ„æºåç§°</th>
                <th>æ‰€å±å›¾ä¹¦</th>
                <th>æ–‡ä»¶ç±»å‹</th>
                <th>æ–‡ä»¶å¤§å°</th>
                <th>å…è®¸é˜…è¯»</th>
                <th>çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody>
        `

        allResources.forEach((resource, index) => {
          const canRead = resource.allowReading
          const statusBadge = canRead 
            ? '<span class="badge badge-success">å¯è®¿é—®</span>'
            : '<span class="badge badge-danger">ä¸å¯è®¿é—®</span>'

          const fileSize = formatFileSize(resource.fileSize)

          resourcesHTML += `
            <tr>
              <td>${index + 1}</td>
              <td><strong>${resource.name}</strong></td>
              <td>${resource.bookName}</td>
              <td>${resource.fileType.toUpperCase()}</td>
              <td>${fileSize}</td>
              <td>${canRead ? 'âœ… æ˜¯' : 'âŒ å¦'}</td>
              <td>${statusBadge}</td>
            </tr>
          `
        })

        resourcesHTML += `
            </tbody>
          </table>
        `

        resourcesContainer.innerHTML = resourcesHTML

        // æ›´æ–°ç»Ÿè®¡
        const canReadResourcesCount = allResources.filter(r => r.allowReading).length
        statusDiv.innerHTML += `<br>ğŸ“ èµ„æº: ${allResources.length} ä¸ª | ${canReadResourcesCount} ä¸ªå¯è®¿é—®`

      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error)
      }
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B'
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB'
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
    loadData()
  </script>
</body>
</html>

