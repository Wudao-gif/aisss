<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°é¢æµ‹è¯•é¡µé¢</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .books-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(205px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .book-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .book-cover {
      width: 205px;
      height: 315px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .book-info {
      font-size: 14px;
      color: #666;
    }
    .book-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .url-display {
      font-size: 12px;
      color: #999;
      word-break: break-all;
      margin-top: 5px;
      padding: 5px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
    .loading {
      background: #fff3cd;
      color: #856404;
    }
  </style>
</head>
<body>
  <h1>ğŸ“š å°é¢æµ‹è¯•é¡µé¢</h1>

  <div class="card">
    <h2>ğŸ” æµ‹è¯•è¯´æ˜</h2>
    <p>è¿™ä¸ªé¡µé¢ä¼šç›´æ¥ä»æ•°æ®åº“è·å–å›¾ä¹¦æ•°æ®å¹¶æ˜¾ç¤ºå°é¢ã€‚</p>
    <p>å¦‚æœè¿™é‡Œèƒ½çœ‹åˆ°å°é¢ï¼Œè¯´æ˜æ•°æ®åº“æ˜¯æ­£ç¡®çš„ï¼Œé—®é¢˜å¯èƒ½åœ¨å‰ç«¯é¡µé¢çš„ç¼“å­˜ã€‚</p>
    <button onclick="loadBooks()">åˆ·æ–°å›¾ä¹¦åˆ—è¡¨</button>
    <button onclick="clearCache()">æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°</button>
  </div>

  <div class="card">
    <h2>ğŸ“Š åŠ è½½çŠ¶æ€</h2>
    <div id="status"></div>
  </div>

  <div class="card">
    <h2>ğŸ“– å›¾ä¹¦åˆ—è¡¨</h2>
    <div id="books-container" class="books-grid"></div>
  </div>

  <script>
    async function loadBooks() {
      const statusDiv = document.getElementById('status')
      const booksContainer = document.getElementById('books-container')

      statusDiv.innerHTML = '<div class="status loading">â³ æ­£åœ¨åŠ è½½å›¾ä¹¦æ•°æ®...</div>'
      booksContainer.innerHTML = ''

      try {
        const response = await fetch('/api/books')
        const data = await response.json()

        if (!data.success) {
          statusDiv.innerHTML = `<div class="status error">âŒ åŠ è½½å¤±è´¥: ${data.message}</div>`
          return
        }

        const books = data.data || []
        
        if (books.length === 0) {
          statusDiv.innerHTML = '<div class="status error">âŒ æ•°æ®åº“ä¸­æ²¡æœ‰å›¾ä¹¦æ•°æ®</div>'
          return
        }

        statusDiv.innerHTML = `<div class="status success">âœ… æˆåŠŸåŠ è½½ ${books.length} æœ¬å›¾ä¹¦</div>`

        // æ˜¾ç¤ºå›¾ä¹¦
        books.forEach((book, index) => {
          const coverUrl = book.coverUrl || book.cover || '/placeholder.svg'
          
          const bookDiv = document.createElement('div')
          bookDiv.className = 'book-item'
          bookDiv.innerHTML = `
            <img 
              src="${coverUrl}" 
              alt="${book.name}"
              class="book-cover"
              onerror="this.style.border='2px solid red'; this.alt='âŒ åŠ è½½å¤±è´¥'"
              onload="this.style.border='2px solid green'"
            >
            <div class="book-title">${index + 1}. ${book.name}</div>
            <div class="book-info">ä½œè€…: ${book.author}</div>
            <div class="book-info">ISBN: ${book.isbn}</div>
            <div class="url-display">
              <strong>å°é¢URL:</strong><br>
              ${coverUrl}
            </div>
            <div style="margin-top: 10px;">
              <button onclick="testImage('${coverUrl}', '${book.name}')">æµ‹è¯•å›¾ç‰‡</button>
            </div>
          `
          booksContainer.appendChild(bookDiv)
        })

      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`
        console.error('åŠ è½½å›¾ä¹¦å¤±è´¥:', error)
      }
    }

    function testImage(url, name) {
      const img = new Image()
      img.onload = function() {
        alert(`âœ… å›¾ç‰‡åŠ è½½æˆåŠŸï¼\n\nä¹¦å: ${name}\nå°ºå¯¸: ${this.width} Ã— ${this.height}`)
      }
      img.onerror = function() {
        alert(`âŒ å›¾ç‰‡åŠ è½½å¤±è´¥ï¼\n\nä¹¦å: ${name}\nURL: ${url}\n\nå¯èƒ½çš„åŸå› :\n1. URL ä¸å¯è®¿é—®\n2. ç½‘ç»œé—®é¢˜\n3. è·¨åŸŸé™åˆ¶`)
      }
      img.src = url
    }

    function clearCache() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢å—ï¼Ÿ')) {
        // æ¸…é™¤ç¼“å­˜çš„æ–¹æ³•
        if ('caches' in window) {
          caches.keys().then(function(names) {
            for (let name of names) {
              caches.delete(name)
            }
          })
        }
        
        // å¼ºåˆ¶åˆ·æ–°
        window.location.reload(true)
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½å›¾ä¹¦
    loadBooks()
  </script>
</body>
</html>

