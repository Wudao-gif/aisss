# HITL 端到端测试指南 - 逐步操作

## 🎯 测试目标

验证 HITL 功能的完整工作流程：
1. 触发中断
2. 显示审批模态框
3. 用户做出决策
4. 恢复执行

## 📋 前置条件

### 1. 启动后端服务
```bash
cd ai-education-service
python -m uvicorn main:app --reload --port 8000
```

**验证**:
- 访问 http://localhost:8000/docs
- 应该看到 Swagger API 文档

### 2. 启动前端应用
```bash
cd 前端web
npm run dev
```

**验证**:
- 访问 http://localhost:3000
- 应该看到登录页面

## 🧪 测试步骤

### 步骤 1: 登录应用

1. 打开浏览器访问 http://localhost:3000
2. 输入测试账户信息
3. 点击"登录"按钮
4. 等待页面加载完成

**预期结果**:
- ✅ 成功登录
- ✅ 看到书架页面

### 步骤 2: 进入 book-chat-v2 页面

1. 选择一本书
2. 点击"进入对话"或直接进入
3. 等待页面加载完成

**预期结果**:
- ✅ 看到对话界面
- ✅ 左侧显示书籍预览
- ✅ 右侧显示对话区域

### 步骤 3: 打开浏览器开发者工具

1. 按 `F12` 打开开发者工具
2. 切换到"控制台"标签
3. 切换到"网络"标签（用于查看 API 请求）

**预期结果**:
- ✅ 看到控制台日志
- ✅ 可以查看网络请求

### 步骤 4: 发送触发中断的消息

在对话框中输入会触发 memory_write 的消息：

```
保存我的学习笔记：今天学习了 HITL 功能，很有意思
```

或者：

```
记录一下：我对这个章节的理解是...
```

**预期结果**:
- ✅ 消息发送
- ✅ 看到"正在输入..."状态
- ✅ 控制台显示日志

### 步骤 5: 观察中断检测

在控制台中查看日志：

```
🛑 检测到 HITL 中断，显示审批模态框
```

**预期结果**:
- ✅ 看到中断日志
- ✅ 看到 HITL 审批模态框弹出

### 步骤 6: 查看待审批操作

模态框中应该显示：
- 操作名称（如 memory_write）
- 操作参数（JSON 格式）
- 允许的决策按钮（批准、拒绝、编辑）

**预期结果**:
- ✅ 模态框显示清晰
- ✅ 操作信息完整
- ✅ 决策按钮可用

### 步骤 7: 测试批准决策

1. 点击"批准"按钮（✓ 图标）
2. 按钮应该变为蓝色
3. 点击"提交决策"按钮

**预期结果**:
- ✅ 按钮状态改变
- ✅ 模态框关闭
- ✅ AI 继续执行
- ✅ 看到 AI 回复

### 步骤 8: 测试拒绝决策

重复步骤 4-6，然后：

1. 点击"拒绝"按钮（✗ 图标）
2. 按钮应该变为红色
3. 点击"提交决策"按钮

**预期结果**:
- ✅ 按钮状态改变
- ✅ 模态框关闭
- ✅ 操作被跳过
- ✅ AI 继续执行

### 步骤 9: 测试编辑决策

重复步骤 4-6，然后：

1. 点击"编辑"按钮（✎ 图标）
2. 看到 JSON 编辑器
3. 修改参数（例如改变值）
4. 点击"保存编辑"
5. 点击"提交决策"

**预期结果**:
- ✅ 编辑器显示
- ✅ 参数可以修改
- ✅ 修改后的参数被执行

## 🔍 调试技巧

### 查看控制台日志

关键日志：
```
🤖 发送 AI 请求: {...}
📡 响应状态: 200 OK
🔗 保存 thread_id: thread_xxx
🛑 检测到 HITL 中断
📤 提交 HITL 决策: [...]
✅ 恢复执行完成
```

### 查看网络请求

1. 打开"网络"标签
2. 查看 `/api/ai/chat` 请求
3. 查看响应头中的 `X-Thread-ID`
4. 查看 `/api/ai/chat/resume` 请求

### 查看浏览器存储

1. 打开"应用"标签
2. 查看 localStorage 中的 authToken
3. 查看 sessionStorage

## ✅ 测试检查清单

### 基础功能
- [ ] 能成功登录
- [ ] 能进入 book-chat-v2 页面
- [ ] 能发送消息
- [ ] 能看到 AI 回复

### HITL 功能
- [ ] 能检测到中断
- [ ] 能显示审批模态框
- [ ] 能看到操作信息
- [ ] 能看到决策按钮

### 决策功能
- [ ] 批准决策能工作
- [ ] 拒绝决策能工作
- [ ] 编辑决策能工作
- [ ] 决策提交能工作

### 恢复功能
- [ ] 能恢复执行
- [ ] 能继续处理 SSE 流
- [ ] 能显示最终结果
- [ ] 能保存对话

## 🐛 常见问题

### Q1: 模态框不显示
**原因**: 中断检测失败
**解决**:
1. 检查控制台是否有错误
2. 检查消息是否触发了 memory_write
3. 检查后端是否返回了 __interrupt__

### Q2: 决策提交失败
**原因**: 决策验证失败
**解决**:
1. 检查是否为所有操作做出了决策
2. 检查决策类型是否被允许
3. 查看控制台错误信息

### Q3: 恢复后没有响应
**原因**: API 调用失败
**解决**:
1. 检查 thread_id 是否正确
2. 检查网络请求是否成功
3. 查看后端日志

## 📊 性能测试

### 测试项目
- [ ] 中断检测延迟 < 100ms
- [ ] 模态框显示延迟 < 200ms
- [ ] 决策提交延迟 < 500ms
- [ ] 恢复执行延迟 < 1s

---

**完成所有步骤后，HITL 功能已验证！** ✅

